╔═══════════════════════════════════════════════════════════════╗
║         RECEIPTSORTER PDF FIX - QUICK REFERENCE CARD          ║
╚═══════════════════════════════════════════════════════════════╝

┌───────────────────────────────────────────────────────────────┐
│ THE PROBLEM                                                   │
├───────────────────────────────────────────────────────────────┤
│ 1. HTTP 405 Error → Blocks ALL PDF processing ðŸ"´ CRITICAL   │
│ 2. Chinese text garbled → Bad extraction 🟡 HIGH            │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ PHASE 1: FIX 405 ERROR (15 MINUTES)                          │
├───────────────────────────────────────────────────────────────┤
│ Files: src/app/api/receipts/[id]/process/route.ts            │
│        src/app/api/receipts/[id]/retry/route.ts              │
│                                                               │
│ Add after imports:                                            │
│   export const runtime = 'nodejs';                            │
│   export const dynamic = 'force-dynamic';                     │
│   export const revalidate = 0;                                │
│                                                               │
│ Deploy & Test:                                                │
│   git commit -m "fix: add route config"                      │
│   git push                                                    │
│   curl -X POST <url>/api/receipts/test/process -v            │
│   Expected: 200/401 (NOT 405) ✅                             │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ PHASE 2: FIX CHINESE EXTRACTION (30 MINUTES)                 │
├───────────────────────────────────────────────────────────────┤
│ File: src/lib/pdf-converter.ts                               │
│                                                               │
│ Change:                                                       │
│   scale: 0.5 → 2.0                                           │
│   MAX_DIMENSION: 1000 → 2400                                 │
│   jpegQuality: 0.6 → 0.95                                    │
│                                                               │
│ File: src/lib/openai.ts                                      │
│                                                               │
│ Add to prompt:                                                │
│   - Chinese field translations (发票号码, 价税合计, etc.)    │
│   - Invoice structure rules                                   │
│   - Category mappings                                         │
│                                                               │
│ Add to API call:                                              │
│   detail: "high" (in image_url object)                       │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ TEST WITH CHINESE PDF                                         │
├───────────────────────────────────────────────────────────────┤
│ File: 1760581209670-wkq633.pdf                               │
│                                                               │
│ Expected Results:                                             │
│   ✓ Invoice: 25332000000398124894                           │
│   ✓ Date: 2025-09-10                                        │
│   ✓ Merchant: 杭州汉盛酒店管理有限公司                        │
│   ✓ Amount: 190.00                                           │
│   ✓ Tax: 1.88                                                │
│   ✓ Currency: CNY                                            │
│   ✓ Category: Travel                                         │
│   ✗ No garbled text (Vý[¶z\u000eR¡)                        │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ IF PHASE 1 FAILS (STILL 405)                                 │
├───────────────────────────────────────────────────────────────┤
│ Option A: Try different export order (move before imports)   │
│ Option B: Create /action route with query params             │
│ Option C: Use catch-all route [...slug]                      │
│ Option D: Switch to edge runtime                             │
│ Option E: Add vercel.json configuration                      │
│                                                               │
│ See: Troubleshooting-Guide.md Section A                      │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ IF EXTRACTION STILL POOR (<80%)                              │
├───────────────────────────────────────────────────────────────┤
│ 1. Increase scale to 2.5 or 3.0                             │
│ 2. Use PNG format (not JPEG)                                 │
│ 3. Add more Chinese examples to prompt                       │
│ 4. Test with OpenAI Playground directly                      │
│ 5. Check image quality manually                              │
│                                                               │
│ Acceptable: >70% with manual correction UI                   │
│ Target: >90% accuracy                                        │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ EMERGENCY WORKAROUNDS                                         │
├───────────────────────────────────────────────────────────────┤
│ If can't fix in 2 hours:                                     │
│                                                               │
│ 1. Disable PDF upload temporarily                            │
│    Comment out: 'application/pdf': ['.pdf']                  │
│    Launch with images only                                    │
│                                                               │
│ 2. Use static endpoint (/api/process-receipt)                │
│    Pass receiptId in body instead of URL                     │
│                                                               │
│ 3. Manual correction mode                                     │
│    Show extracted data as editable                           │
│    User corrects mistakes                                     │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ USEFUL COMMANDS                                               │
├───────────────────────────────────────────────────────────────┤
│ Test endpoint:                                                │
│   curl -X POST <url>/api/receipts/test/process \            │
│     -H "Content-Type: application/json" -v                   │
│                                                               │
│ Check logs:                                                   │
│   vercel logs --follow                                       │
│                                                               │
│ List deployments:                                             │
│   vercel ls                                                  │
│                                                               │
│ Force redeploy:                                               │
│   git commit --allow-empty -m "chore: redeploy"             │
│   git push                                                    │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ SUCCESS INDICATORS                                            │
├───────────────────────────────────────────────────────────────┤
│ Phase 1 Working:                                              │
│   ☑ curl returns 200/401                                    │
│   ☑ Server logs appear                                       │
│   ☑ Status → processing → completed                         │
│   ☑ Credits deducted                                         │
│                                                               │
│ Phase 2 Working:                                              │
│   ☑ Chinese characters correct                               │
│   ☑ Invoice number extracted                                 │
│   ☑ Amount/date accurate                                     │
│   ☑ Confidence >0.85                                         │
│   ☑ Export works correctly                                   │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ TIME ESTIMATES                                                │
├───────────────────────────────────────────────────────────────┤
│ Best Case:    45 minutes total                               │
│ Realistic:    2 hours total                                  │
│ Worst Case:   4-6 hours total                                │
│                                                               │
│ Deadline:     Must fix Phase 1 before launch                 │
│               Phase 2 can iterate post-launch                 │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│ DOCUMENT GUIDE                                                │
├───────────────────────────────────────────────────────────────┤
│ 1. README-START-HERE.md ........... Overview & decisions     │
│ 2. Quick-Start-Fix-Guide.md ....... Action steps (READ 1ST)  │
│ 3. Exact-Code-Changes.md .......... Copy-paste snippets      │
│ 4. Visual-Problem-Breakdown.md .... Understanding why        │
│ 5. Troubleshooting-Guide.md ....... If stuck (READ 2ND)      │
│ 6. PDF-Parsing-Fix-Plan.md ........ Full details            │
└───────────────────────────────────────────────────────────────┘

╔═══════════════════════════════════════════════════════════════╗
║ START HERE: Quick-Start-Fix-Guide.md → Phase 1 → Step 1      ║
║ KEEP OPEN: Exact-Code-Changes.md while coding                ║
║ IF STUCK: Troubleshooting-Guide.md → Section matching error  ║
╚═══════════════════════════════════════════════════════════════╝

Print this card and keep it visible while working!
